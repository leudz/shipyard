<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Custom Views - Shipyard User&#x27;s Guide</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../welcome.html">Welcome</a></li><li class="chapter-item expanded "><a href="../fundamentals.html"><strong aria-hidden="true">1.</strong> Fundamentals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../fundamentals/world.html"><strong aria-hidden="true">1.1.</strong> World</a></li><li class="chapter-item expanded "><a href="../fundamentals/add-entity.html"><strong aria-hidden="true">1.2.</strong> Add Entity</a></li><li class="chapter-item expanded "><a href="../fundamentals/delete-entity.html"><strong aria-hidden="true">1.3.</strong> Delete Entity</a></li><li class="chapter-item expanded "><a href="../fundamentals/add-components.html"><strong aria-hidden="true">1.4.</strong> Add Components</a></li><li class="chapter-item expanded "><a href="../fundamentals/remove-components.html"><strong aria-hidden="true">1.5.</strong> Remove Components</a></li><li class="chapter-item expanded "><a href="../fundamentals/delete-components.html"><strong aria-hidden="true">1.6.</strong> Delete Components</a></li><li class="chapter-item expanded "><a href="../fundamentals/get-and-modify.html"><strong aria-hidden="true">1.7.</strong> Get and Modify Components</a></li><li class="chapter-item expanded "><a href="../fundamentals/iterators.html"><strong aria-hidden="true">1.8.</strong> Iterators</a></li><li class="chapter-item expanded "><a href="../fundamentals/uniques.html"><strong aria-hidden="true">1.9.</strong> Uniques</a></li><li class="chapter-item expanded "><a href="../fundamentals/systems.html"><strong aria-hidden="true">1.10.</strong> Systems</a></li></ol></li><li class="chapter-item expanded "><a href="../going-further.html"><strong aria-hidden="true">2.</strong> Going Further</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../going-further/tracking.html"><strong aria-hidden="true">2.1.</strong> Tracking</a></li><li class="chapter-item expanded "><a href="../going-further/parallelism.html"><strong aria-hidden="true">2.2.</strong> Parallelism</a></li><li class="chapter-item expanded "><a href="../going-further/custom-views.html" class="active"><strong aria-hidden="true">2.3.</strong> Custom Views</a></li><li class="chapter-item expanded "><a href="../going-further/non-send-sync.html"><strong aria-hidden="true">2.4.</strong> !Send and !Sync Components</a></li><li class="chapter-item expanded "><a href="../going-further/performance-tips.html"><strong aria-hidden="true">2.5.</strong> Performance Tips</a></li></ol></li><li class="chapter-item expanded "><a href="../going-deeper.html"><strong aria-hidden="true">3.</strong> Going Deeper</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../going-deeper/workload-creation.html"><strong aria-hidden="true">3.1.</strong> Workload creation</a></li><li class="chapter-item expanded "><a href="../going-deeper/sparse-set.html"><strong aria-hidden="true">3.2.</strong> Sparse Set</a></li></ol></li><li class="chapter-item expanded "><a href="../recipes.html"><strong aria-hidden="true">4.</strong> Recipes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../recipes/hierarchy.html"><strong aria-hidden="true">4.1.</strong> Hierarchy</a></li><li class="chapter-item expanded "><a href="../recipes/seed.html"><strong aria-hidden="true">4.2.</strong> Seed</a></li><li class="chapter-item expanded "><a href="../recipes/0.4-migration.html"><strong aria-hidden="true">4.3.</strong> 0.4 migration</a></li></ol></li><li class="chapter-item expanded "><a href="../pilgrimage.html"><strong aria-hidden="true">5.</strong> Pilgrimage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../pilgrimage/more-resources.html"><strong aria-hidden="true">5.1.</strong> More Resources</a></li><li class="chapter-item expanded "><a href="../pilgrimage/related-crates.html"><strong aria-hidden="true">5.2.</strong> Shipyard Related Crates</a></li><li class="chapter-item expanded "><a href="../pilgrimage/projects-using-shipyard.html"><strong aria-hidden="true">5.3.</strong> Projects using Shipyard</a></li></ol></li><li class="chapter-item expanded "><a href="../contributors.html"><strong aria-hidden="true">6.</strong> Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Shipyard User&#x27;s Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/leudz/shipyard" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/leudz/shipyard/edit/master/guide/master/src/going-further/custom-views.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="custom-views"><a class="header" href="#custom-views">Custom Views</a></h1>
<p>Custom views are types that you can borrow (like <code>View</code> or <code>UniqueView</code>) but are not provided by <code>shipyard</code>.</p>
<p>Many types can become custom views, they'll fall into one of two categories: View Bundle or Wild View.
View bundles only contain other views while wild views can contain other types.</p>
<p>Example of a View Bundle:</p>
<pre><code class="language-rust  noplaypen">struct Hierarchy&lt;'v&gt; {
    entities: EntitiesViewMut&lt;'v&gt;,
    parents: ViewMut&lt;'v, Parent&gt;,
    children: ViewMut&lt;'v, Child&gt;,
}</code></pre>
<p>Example of a Wild View:</p>
<pre><code class="language-rust  noplaypen">struct RandomNumber(u64);</code></pre>
<h3 id="concrete-example"><a class="header" href="#concrete-example">Concrete example</a></h3>
<p>When creating a frame with any low level api there is always some boilerplate. We'll look at how custom views can help for <code>wgpu</code>.</p>
<p>The original code creates the frame in a system by borrowing <code>Graphics</code> which contains everything needed.
The rendering part just clears the screen with a color.</p>
<p>The entire starting code for this chapter is available in <a href="./custom_views_original.rs">this file</a>. You can copy all of it in a fresh <code>main.rs</code> and edit the fresh <code>Cargo.toml</code>.</p>
<details>
<summary>Original</summary>
<pre><code class="language-rust  noplaypen">#[derive(Unique)]
struct Graphics {
    surface: wgpu::Surface,
    device: wgpu::Device,
    queue: wgpu::Queue,
    config: wgpu::SurfaceConfiguration,
    size: winit::dpi::PhysicalSize&lt;u32&gt;,
}

fn render(graphics: UniqueView&lt;Graphics&gt;) -&gt; Result&lt;(), wgpu::SurfaceError&gt; {
    // Get a few things from the GPU
    let output = graphics.surface.get_current_texture()?;
    let view = output
        .texture
        .create_view(&amp;wgpu::TextureViewDescriptor::default());

    let mut encoder = graphics
        .device
        .create_command_encoder(&amp;wgpu::CommandEncoderDescriptor {
            label: Some(&quot;Render Encoder&quot;),
        });

    {
        // RenderPass borrows encoder for all its lifetime
        let mut _render_pass = encoder.begin_render_pass(&amp;wgpu::RenderPassDescriptor {
            label: Some(&quot;Render Pass&quot;),
            color_attachments: &amp;[wgpu::RenderPassColorAttachment {
                view: &amp;view,
                resolve_target: None,
                ops: wgpu::Operations {
                    load: wgpu::LoadOp::Clear(wgpu::Color {
                        r: 0.1,
                        g: 0.2,
                        b: 0.3,
                        a: 1.0,
                    }),
                    store: true,
                },
            }],
            depth_stencil_attachment: None,
        });
    }

    // encoder.finish() consumes `encoder`, so the RenderPass needs to disappear before that to release the borrow
    graphics.queue.submit(iter::once(encoder.finish()));
    output.present();

    Ok(())
}</code></pre>
</details>
<p>We want to abstract the beginning and end of the system to get this version working.
The error handling is going to move, we could keep it closer to the original by having a <code>ResultRenderGraphicsViewMut</code> for example. </p>
<pre><code class="language-rust  noplaypen">fn render(mut graphics: RenderGraphicsViewMut) {
    let mut _render_pass = graphics
        .encoder
        .begin_render_pass(&amp;wgpu::RenderPassDescriptor {
            label: Some(&quot;Render Pass&quot;),
            color_attachments: &amp;[wgpu::RenderPassColorAttachment {
                view: &amp;graphics.view,
                resolve_target: None,
                ops: wgpu::Operations {
                    load: wgpu::LoadOp::Clear(wgpu::Color {
                        r: 0.1,
                        g: 0.2,
                        b: 0.3,
                        a: 1.0,
                    }),
                    store: true,
                },
            }],
            depth_stencil_attachment: None,
        });
}</code></pre>
<p>We'll start by creating a struct to hold our init state.</p>
<pre><code class="language-rust  noplaypen">struct RenderGraphicsViewMut {
    view: wgpu::TextureView,
    encoder: wgpu::CommandEncoder,
}</code></pre>
<p>Now let's make this struct able to be borrowed and generate the initial state we need.</p>
<pre><code class="language-rust  noplaypen">impl&lt;'v&gt; shipyard::Borrow&lt;'v&gt; for RenderGraphicsViewMut {
    type View = RenderGraphicsViewMut;

    fn borrow(
        world: &amp;'v shipyard::World,
        last_run: Option&lt;u32&gt;,
        current: TrackingTimestamp,
    ) -&gt; Result&lt;Self::View, shipyard::error::GetStorage&gt; {
        // Even if we don't use tracking for Graphics, it's good to build an habit of using last_run and current when creating custom views
        let graphics = &lt;UniqueView&lt;Graphics&gt; as shipyard::IntoBorrow&gt;::Borrow::borrow(
            world, last_run, current,
        )?;
        // This error will now be reported as an error during the view creation process and not the system but is still bubbled up
        let output = graphics
            .surface
            .get_current_texture()
            .map_err(shipyard::error::GetStorage::from_custom)?;
        let view = output
            .texture
            .create_view(&amp;wgpu::TextureViewDescriptor::default());

        let encoder = graphics
            .device
            .create_command_encoder(&amp;wgpu::CommandEncoderDescriptor {
                label: Some(&quot;Render Encoder&quot;),
            });

        Ok(RenderGraphicsViewMut {
            encoder,
            view,
        })
    }
}</code></pre>
<p>We now have a custom view! We can't change our system just yet, we're missing <code>output</code>.</p>
<p>Let's add <code>output</code> and <code>graphics</code> to our custom view.</p>
<pre><code class="language-rust  noplaypen">struct RenderGraphicsViewMut&lt;'v&gt; {
    encoder: wgpu::CommandEncoder,
    view: wgpu::TextureView,
    // New fields
    output: Option&lt;wgpu::SurfaceTexture&gt;,
    graphics: UniqueView&lt;'v, Graphics&gt;,
}</code></pre>
<p>Since our view now has a lifetime we need a bit of boilerplate (<a href="../going-deeper/workload-creation.html">explanation</a>).</p>
<pre><code class="language-rust  noplaypen">struct RenderGraphicsBorrower {}

impl shipyard::IntoBorrow for RenderGraphicsViewMut&lt;'_&gt; {
    type Borrow = RenderGraphicsBorrower;
}</code></pre>
<p>With that our of the way we can revisit our <code>Borrow</code> implementation and add one for <code>Drop</code>.</p>
<pre><code class="language-rust  noplaypen">impl&lt;'v&gt; shipyard::Borrow&lt;'v&gt; for RenderGraphicsBorrower {
    type View = RenderGraphicsViewMut&lt;'v&gt;;

    fn borrow(
        world: &amp;'v shipyard::World,
        last_run: Option&lt;u32&gt;,
        current: TrackingTimestamp,
    ) -&gt; Result&lt;Self::View, shipyard::error::GetStorage&gt; {
        let graphics = &lt;UniqueView&lt;Graphics&gt; as shipyard::IntoBorrow&gt;::Borrow::borrow(
            world, last_run, current,
        )?;
        let output = graphics
            .surface
            .get_current_texture()
            .map_err(shipyard::error::GetStorage::from_custom)?;
        let view = output
            .texture
            .create_view(&amp;wgpu::TextureViewDescriptor::default());

        let encoder = graphics
            .device
            .create_command_encoder(&amp;wgpu::CommandEncoderDescriptor {
                label: Some(&quot;Render Encoder&quot;),
            });

        Ok(RenderGraphicsViewMut {
            encoder,
            view,
            output: Some(output),
            graphics,
        })
    }
}

impl Drop for RenderGraphicsViewMut&lt;'_&gt; {
    fn drop(&amp;mut self) {
        // I chose to swap here to not have to use an `Option&lt;wgpu::CommandEncoder&gt;` in a publicly accessible field
        let encoder = std::mem::replace(
            &amp;mut self.encoder,
            self.graphics
                .device
                .create_command_encoder(&amp;wgpu::CommandEncoderDescriptor {
                    label: Some(&quot;Render Encoder&quot;),
                }),
        );

        self.graphics.queue.submit(iter::once(encoder.finish()));
        // output on the other hand is only used here so an `Option` is good enough
        self.output.take().unwrap().present();
    }
}</code></pre>
<p>Our custom view is now fully functional and we successfully moved code that would be duplicated out of the render system.
You can remove the error handling in <code>main.rs</code> to see the result.</p>
<p>As a final touch we can implement <code>BorrowInfo</code> and <code>AllStoragesBorrow</code>. Respectively to make our view work with workloads and <code>AllStorages</code>.</p>
<pre><code class="language-rust  noplaypen">// SAFE: All storages info is recorded.
unsafe impl shipyard::BorrowInfo for RenderGraphicsViewMut&lt;'_&gt; {
    fn borrow_info(info: &amp;mut Vec&lt;shipyard::info::TypeInfo&gt;) {
        &lt;UniqueView&lt;Graphics&gt;&gt;::borrow_info(info);
    }
}

impl&lt;'v&gt; shipyard::AllStoragesBorrow&lt;'v&gt; for RenderGraphicsBorrower {
    fn all_borrow(
        all_storages: &amp;'v shipyard::AllStorages,
        last_run: Option&lt;u32&gt;,
        current: TrackingTimestamp,
    ) -&gt; Result&lt;Self::View, shipyard::error::GetStorage&gt; {
        let graphics = &lt;UniqueView&lt;Graphics&gt; as shipyard::IntoBorrow&gt;::Borrow::all_borrow(
            all_storages,
            last_run,
            current,
        )?;
        let output = graphics
            .surface
            .get_current_texture()
            .map_err(shipyard::error::GetStorage::from_custom)?;
        let view = output
            .texture
            .create_view(&amp;wgpu::TextureViewDescriptor::default());

        let encoder = graphics
            .device
            .create_command_encoder(&amp;wgpu::CommandEncoderDescriptor {
                label: Some(&quot;Render Encoder&quot;),
            });

        Ok(RenderGraphicsViewMut {
            encoder,
            view,
            output: Some(output),
            graphics,
        })
    }
}</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../going-further/parallelism.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../going-further/non-send-sync.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../going-further/parallelism.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../going-further/non-send-sync.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
